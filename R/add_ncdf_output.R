#' Add output from model-specific model runs to  netcdf file
#'
#' Add data from lists of output, generated by run_ensemble to  a netcdf file created by earlier
#' run of run_ensemble
#'
#' @param output_lists list; list containing lists of output (e.g. temperature, ice_height)
#' @param folder filepath; to folder which contains the model folders generated by export_config()
#' @param model vector; model to export driving data. Options include c("GOTM", "GLM", "Simstrat",
#' "FLake", "MyLake")
#' @param out_file filepath; to save netCDF file defaults to "ensemble_output.nc"
#' @import ncdf4
#' @importFrom rLakeAnalyzer get.offsets
#'
#' @keywords internal

add_netcdf_output <- function(output_lists, folder = ".", model, out_file) {
  
 
  # create connection
  nc <- ncdf4::nc_open(file.path(folder, "output", out_file), write=TRUE)
  
  # make sure the connection is closed on exit
  on.exit({
   ncdf4::nc_close(nc)
  })

  # # check for models
  # Extract model names
  mod_names <- ncatt_get(nc, "model", "Model")$value
  mod_names <- strsplit(mod_names, ", ")[[1]]
  mod_names <- substring(mod_names, 5)
  mod_names <- mod_names[!mod_names %in% "Obs"]
  
  # sort models so they match the attribute number
  model <- model[match(model, mod_names)]
  
  # ncdf4::ncvar_get(nc, "model")
  
  # check for variables
  vars_old <- names(nc$var)
 
  #get maximum member number
  mem_num_max <- length(nc$dim$member$vals)
  
  #set new member number to old + 1
  mem_num_new <- mem_num_max + 1
  
  # Extract missing value
  miss_val <- lapply(seq_len(length(vars_old)), function(x)ncatt_get(nc, vars_old[x])$missing_value)
 
  
  # Loop through and add each variable
  #  different for 2D or 3D variables
  for(i in seq_len(length(output_lists))) {
    
    if(ncol(output_lists[[i]][[1]]) == 2) {
      # Add 2D variable
      for (m in seq_len(length(model))) {
        dat_add <- as.matrix(output_lists[[i]][[m]][, -1])
        ncdf4::ncvar_put(nc, vars_old[i], dat_add, start = c(1, 1, mem_num_new, m, 1),
                         count = c(1, 1, 1, 1, length(dat_add)))
      }

    } else if(ncol(output_lists[[i]][[1]]) > 2) {
      # Add 3D variable
      for (m in seq_len(length(model))) {
        dat_add <- as.matrix(output_lists[[i]][[m]][, !colnames(output_lists[[i]][[m]]) %in%
                                                                                        "datetime"])
        dat_add[is.na(dat_add)] <- miss_val[[i]]
        ncdf4::ncvar_put(nc, vars_old[i], dat_add, start = c(1, 1, mem_num_new, m, 1, 1),
                         count = c(1, 1, 1, 1, nrow(dat_add), ncol(dat_add)))
      }
    }
  }

  
  message("Finished adding data to NetCDF file [", Sys.time(), "]")
  
}
