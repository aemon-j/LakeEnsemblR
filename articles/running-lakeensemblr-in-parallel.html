<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Running LakeEnsemblR in parallel • LakeEnsemblR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Running LakeEnsemblR in parallel">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">LakeEnsemblR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.9</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Get started</h6></li>
    <li><a class="dropdown-item" href="../articles/lakeensemblr-overview.html">LakeEnsemblR: Basic Use and Sample Applications</a></li>
    <li><a class="dropdown-item" href="../articles/setting-up-lakeensemblr.html">Setting up LakeEnsemblR</a></li>
    <li><a class="dropdown-item" href="../articles/running-lakeensemblr.html">Running LakeEnsemblR</a></li>
    <li><a class="dropdown-item" href="../articles/running-lakeensemblr-in-parallel.html">Running LakeEnsemblR in parallel</a></li>
    <li><a class="dropdown-item" href="../articles/post-processing-lakeensemblr.html">Post-processing LakeEnsemblR</a></li>
    <li><a class="dropdown-item" href="../articles/calibrating-lakeensemblr.html">Calibrating LakeEnsemblR</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Installation</h6></li>
    <li><a class="dropdown-item" href="../articles/docker.html">Docker</a></li>
    <li><a class="dropdown-item" href="../articles/installation-issues.html">Installation issues</a></li>
    <li><a class="dropdown-item" href="../articles/faq.html">FAQ</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Other</h6></li>
    <li><a class="dropdown-item" href="../articles/what-is-a-netcdf-file.html">What is a NetCDF file</a></li>
    <li><a class="dropdown-item" href="../articles/lake-models.html">Lake Models</a></li>
    <li><a class="dropdown-item" href="../articles/package-structure.html">Package structure</a></li>
    <li><a class="dropdown-item" href="../articles/from-v1-0-to-v1-1-changes.html">From v1.0 to v1.1 changes</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/aemon-j/LakeEnsemblR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Running LakeEnsemblR in parallel</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/aemon-j/LakeEnsemblR/blob/main/vignettes/articles/running-lakeensemblr-in-parallel.Rmd" class="external-link"><code>vignettes/articles/running-lakeensemblr-in-parallel.Rmd</code></a></small>
      <div class="d-none name"><code>running-lakeensemblr-in-parallel.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="running-lakeensemblr-in-parallel">Running LakeEnsemblR in parallel<a class="anchor" aria-label="anchor" href="#running-lakeensemblr-in-parallel"></a>
</h2>
<p>It is possible to run the <code>run_ensemble</code> and
<code>cali_ensemble</code> functions in parallel, with each model
assigned to a separate core, using the <code>parallel = TRUE</code>
argument. This will speed up the computation, although the runtime
depends on the slowest model. It is currently not possible to divide the
tasks of these functions even more efficiently over cores.</p>
<p>However, if you are planning to run LakeEnsemblR repeatedly for
multiple lakes/forcings/parameter sets and you work in Rstudio, it is
possible to use Rstudio’s “jobs” to have these repeated runs done in
parallel. There are probably other ways of doing something similar, but
here we’ll give some instructions on how to set this up.</p>
<div class="section level3">
<h3 id="divide-tasks-over-cores">1. Divide tasks over cores<a class="anchor" aria-label="anchor" href="#divide-tasks-over-cores"></a>
</h3>
<p>There are many ways of doing this, but if you can estimate how long
each individual run takes, you should try to divide these tasks equally
over the amount of cores that you want to use. A good option might be to
order the tasks from long to short, loop through these tasks, and put
each task on the core that is currently most empty. You will now have a
data.frame with all the tasks and the core/job that you want to run it
on. We’ll call this data.frame “df_tasks”.</p>
</div>
<div class="section level3">
<h3 id="make-a-script-that-runs-lakeensemblr-on-a-single-core">2. Make a script that runs LakeEnsemblR on a single core<a class="anchor" aria-label="anchor" href="#make-a-script-that-runs-lakeensemblr-on-a-single-core"></a>
</h3>
<p>You now need to make a script that runs LakeEnsemblR on a single
core; let’s call it “run_LER_on_core.R”. In Step 3, we’ll call this
script in each separate job. This script will be able to access the
global environment of your main script (you will have to reload
libraries), but it should only run the tasks set for this specific
job/core. So, a good idea for a first line is
<code>df_tasks &lt;- df_tasks[df_tasks$Core == core_job,]</code>, where
<code>Core</code> is the column in df_tasks that states on what core the
task in that row should be run. <code>core_job</code> we’ll define in
Step 3.</p>
<p>After this, you need to write a loop over the rows in df_tasks, and
this row should contain the information needed to run LakeEnsemblR. For
example, the row can point to a folder where you have all the necessary
files. In that case, your next lines should be setwd(…),
export_config(…), run_ensemble(…). Because it is a loop, if you have
multiple tasks on one core, these will be done after each other.</p>
</div>
<div class="section level3">
<h3 id="start-the-separate-cores">3. Start the separate cores<a class="anchor" aria-label="anchor" href="#start-the-separate-cores"></a>
</h3>
<p>In Step 1 you have decided how many cores you want to use, let’s call
this “num_cores”. In this case, the code to run your simulations will
look like this:</p>
<pre><code><span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">num_cores</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">core_job</span> <span class="op">&lt;-</span> <span class="va">i</span></span>
<span>  <span class="fu">rstudioapi</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/rstudioapi/reference/jobRunScript.html" class="external-link">jobRunScript</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"run_LER_on_core.R"</span>,</span>
<span>                           importEnv <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                           name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"job_"</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre>
<p>In this case, the “run_LER_on_core.R” script is in your working
directory.</p>
<p>This will start your run on multiple cores.</p>
<p>(Inspiration for this set-up came from this <a href="https://edwinth.github.io/blog/parallel-jobs/" class="external-link">blog post</a>.)</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Tadhg Moore, Robert Ladwig, Johannes Feldbauer, Jorrit Mesman.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
